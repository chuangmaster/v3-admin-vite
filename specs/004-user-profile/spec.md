# Feature Specification: 用戶個人資料與選單權限管理

**Feature Branch**: `004-user-profile`  
**Created**: 2026-01-16  
**Status**: Draft  
**Input**: User description: "用戶帳號管理功能，包括查看個人資訊、修改密碼，以及修復選單權限顯示問題"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看個人帳號資訊 (Priority: P1)

登入用戶需要查看自己的基本帳號資訊，包括顯示名稱、帳號和角色，以便確認身份和權限範圍。用戶可透過右上角的個人資料下拉選單快速存取這些資訊。

**Why this priority**: 這是用戶識別自己身份和了解權限的基礎功能，為其他個人化功能奠定基礎。

**Independent Test**: 用戶登入後點擊右上角 profile 下拉選單，能看到完整的帳號資訊（顯示名稱、帳號、角色），即可驗證此功能獨立運作正常。

**Acceptance Scenarios**:

1. **Given** 用戶已登入系統，**When** 點擊右上角的 profile 下拉選單，**Then** 顯示包含顯示名稱(display_name)、帳號(account)、角色(role)的資訊面板
2. **Given** 用戶查看帳號資訊，**When** 系統顯示帳號欄位，**Then** 該欄位應顯示正確的帳號資訊（注意：目前系統中 account 欄位實際對應 username，需進行重構以保持語意一致性）

---

### User Story 2 - 修改個人密碼 (Priority: P1)

登入用戶需要能夠自行修改密碼，以維護帳號安全性。修改密碼功能應從右上角 profile 選單進入，提供簡單明確的操作流程。

**Why this priority**: 密碼修改是帳號安全的核心功能，允許用戶定期更新密碼或在懷疑帳號安全時立即採取行動。

**Independent Test**: 用戶透過 profile 選單進入修改密碼頁面，輸入舊密碼和新密碼後成功儲存，下次使用新密碼登入成功，即可驗證此功能獨立運作。

**Acceptance Scenarios**:

1. **Given** 用戶已登入系統，**When** 點擊右上角 profile 下拉選單並選擇「修改密碼」選項，**Then** 導向修改密碼頁面
2. **Given** 用戶在修改密碼頁面，**When** 輸入正確的舊密碼、新密碼和確認新密碼，**Then** 系統成功更新密碼並顯示成功訊息
3. **Given** 用戶在修改密碼頁面，**When** 輸入錯誤的舊密碼，**Then** 系統顯示錯誤訊息且不更新密碼
4. **Given** 用戶在修改密碼頁面，**When** 新密碼與確認密碼不一致，**Then** 系統顯示錯誤訊息且不更新密碼4-1. **Given** 用戶在修改密碼頁面,**When** 新密碼與舊密碼相同,**Then** 系統顯示警告訊息但仍允許儲存,密碼更新成功5. **Given** 用戶成功修改密碼，**When** 登出後使用新密碼重新登入，**Then** 能成功登入系統
6. **Given** 用戶在裝置 A 和裝置 B 同時登入，**When** 在裝置 A 成功修改密碼，**Then** 裝置 B 的 session 失效，需要使用新密碼重新登入，而裝置 A 保持登入狀態

---

### User Story 3 - 選單權限正確顯示 (Priority: P2)

當用戶沒有特定選單項目的存取權限時，該選單項目不應顯示在導航選單中，避免用戶誤以為自己有權限而產生困惑。

**Why this priority**: 雖然目前系統已阻止無權限用戶進入頁面，但顯示無法存取的選單會造成不良的用戶體驗，修正此問題可提升系統易用性。

**Independent Test**: 以不同權限的用戶帳號登入，檢查顯示的選單項目是否僅包含該用戶有權限存取的項目，並嘗試存取無權限項目時確實被阻擋。

**Acceptance Scenarios**:

1. **Given** 用戶對某選單項目沒有存取權限，**When** 用戶登入並查看導航選單，**Then** 該選單項目不應出現在選單列表中
2. **Given** 用戶對某選單項目有存取權限，**When** 用戶登入並查看導航選單，**Then** 該選單項目應正常顯示且可點擊
3. **Given** 用戶嘗試直接存取無權限的路徑（例如透過 URL），**When** 系統檢查權限，**Then** 應重導至錯誤頁面或首頁，並顯示權限不足訊息

---

### Edge Cases

*(無未解決的邊緣情境 - 所有關鍵問題已於 Clarifications 中澄清)*

## Clarifications

### Session 2026-01-16

- Q: 密碼修改後的 Session 處理 → A: 僅當前 session 保持，其他 session 失效並要求重新登入（提升安全性）
- Q: 新密碼與舊密碼相同時的處理 → A: 允許設定相同密碼,顯示警告訊息但仍可儲存(避免阻斷用戶操作)
- Q: 權限變更後選單的即時更新 → A: 下次重新載入頁面時更新(簡化實作,降低複雜度)
- Q: 連續輸入錯誤密碼的帳號保護 → A: 不實作鎖定機制,僅記錄日誌(簡化實作,降低管理成本)
- Q: account/username 欄位重構的資料遷移策略 → A: 同時重構資料庫欄位(從 username 改為 account),執行完整遷移

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須在用戶登入後於右上角提供 profile 下拉選單，顯示用戶的顯示名稱、帳號和角色資訊
- **FR-002**: 系統必須提供「修改密碼」選項於 profile 下拉選單中
- **FR-003**: 系統必須提供獨立的修改密碼頁面，包含舊密碼、新密碼和確認新密碼輸入欄位
- **FR-004**: 系統必須驗證舊密碼的正確性，只有正確的舊密碼才能進行密碼更新
- **FR-004-1**: 系統必須記錄用戶輸入錯誤舊密碼的嘗試（包含用戶識別、時間戳、IP位址），用於安全審計，但不實作帳號鎖定機制
- **FR-005**: 系統必須驗證新密碼與確認密碼的一致性- **FR-005-1**: 當新密碼與舊密碼相同時,系統應顯示警告訊息提醒用戶,但仍允許儲存並完成密碼更新流程- **FR-006**: 系統必須在密碼修改成功後持久化儲存新密碼（採用安全的雜湊演算法）
- **FR-006-1**: 系統必須在用戶成功修改密碼後，使該用戶的其他所有裝置/瀏覽器的登入 session 失效，僅保留當前操作的 session
- **FR-007**: 系統必須根據用戶的權限配置，僅顯示該用戶有權存取的選單項目- **FR-007-1**: 當用戶權限在使用期間被變更時,選單顯示將在用戶下次重新載入頁面時更新,無需實作即時推送機制- **FR-008**: 系統必須阻止用戶直接透過 URL 存取無權限的頁面，並導向適當的錯誤頁面
- **FR-009**: 系統必須在修改密碼成功後向用戶顯示成功訊息
- **FR-010**: 系統必須在修改密碼失敗時向用戶顯示具體的錯誤訊息（如「舊密碼不正確」、「新密碼與確認密碼不一致」）
- **FR-011**: 系統必須重構現有的 username 欄位為 account 欄位，確保語意一致性（技術債務清理）
- **FR-011-1**: 欄位重構必須同時包含資料庫層面（將 username 欄位重命名為 account）和應用層面（程式碼中的相關變數、函式、API）
- **FR-011-2**: 資料庫遷移必須確保所有現有資料的完整性和一致性，並提供回滾機制以防遷移失敗

### Key Entities

- **用戶帳號 (User Account)**: 代表登入用戶的身份，包含顯示名稱、帳號識別、角色、密碼等屬性
- **角色 (Role)**: 定義用戶的權限集合，決定用戶可以存取哪些選單和功能
- **選單項目 (Menu Item)**: 系統導航選單中的各個項目，每個項目關聯特定的權限要求

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶能在 3 秒內從 profile 選單查看到自己的完整帳號資訊
- **SC-002**: 用戶能在 2 分鐘內完成密碼修改流程（包含找到入口、填寫表單、確認成功）
- **SC-003**: 系統選單僅顯示用戶有權限存取的項目，無權限項目隱藏率達 100%
- **SC-004**: 用戶嘗試存取無權限頁面時，100% 的情況下會被正確阻擋並重導
- **SC-005**: 密碼修改功能的表單驗證準確率達 100%（錯誤輸入均能被正確識別並提示）
- **SC-006**: 與選單權限相關的用戶困惑或支援請求減少至少 70%（相較於修正前）
- **SC-007**: 新密碼在修改後立即生效，用戶在下次登入時使用新密碼的成功率達 100%

## Assumptions

- 系統已有現有的用戶認證和權限管理機制
- 用戶資料（包含 username/account、display_name、role）已存在於資料庫中
- 系統已實作基本的路由守衛功能，本功能將強化選單顯示邏輯
- 密碼修改不會影響用戶的其他 session（除非明確要求登出所有裝置）
- username 到 account 的重構包含資料庫遷移，需要慣重規劃並確保遷移過程中的系統穩定性和資料完整性
- 選單權限配置已經在系統中定義，本功能是修正顯示邏輯而非重新定義權限結構- 用戶權限變更後不需要即時反映在當前 session,用戶重新載入頁面或下次登入時即可生效- 密碼強度驗證規則（如最小長度、複雜度要求）已由系統其他部分定義，本功能遵循既有規則
