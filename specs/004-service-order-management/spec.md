# Feature Specification: 服務單管理

**Feature Branch**: `004-service-order-management`  
**Created**: 2025-12-14  
**Status**: Draft  
**Input**: User description: "服務單管理模組，使用者可以透過功能，來建立、查詢、修改寄賣單與收購單"

## Clarifications

### Session 2025-12-14

- Q: 身分證明文件上傳時機 - 若客戶是重複交易（既有客戶且先前已上傳過身分證明），是否仍需要每次都重新上傳？ → A: 每次建立服務單都必須上傳身分證明文件（即使是既有客戶）
- Q: 線下簽名的分次流程 - 線下簽名是否需要特定硬體設備（如簽名板），還是僅在螢幕上用滑鼠/觸控筆簽名？ → A: 使用網頁觸控簽名功能，客戶可在螢幕上用滑鼠、觸控筆或手指簽名
- Q: 服務單編號生成規則 - 編號格式與生成規則為何？ → A: 包含類型前綴、日期與流水號，寄賣單前綴 CS，收購單前綴 BS（如 CS20251214001、BS20251214001）
- Q: 寄賣日期預設期間 - 寄賣日期區間的預設期間長度為何？ → A: 預設 3 個月（90 天）
- Q: 服務單狀態轉換規則 - 狀態之間是否可以雙向轉換，或是否有特定的狀態轉換限制？ → A: 允許有限度的逆向轉換（如「已完成」可改回「待處理」，但「已終止」不可逆）
- Q: Excel 匯出欄位的詳細資訊 - Excel 中「商品資訊」欄位應該如何呈現？ → A: 分開為獨立欄位（品牌名稱、款式、內碼、商品數量各佔一欄）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 建立收購單 (Priority: P1)

店員需要快速建立收購單以記錄客戶的精品收購交易，包含客戶資訊、商品詳情與收購金額，並確保收購合約完整簽署。

**Why this priority**: 收購單是核心業務流程，直接影響交易完成與合規性（身分證明與合約簽署），是系統最基本的價值交付。

**Independent Test**: 可透過建立一筆完整的收購單（包含客戶選擇、商品資訊填寫、身分證明上傳、線下簽名）並驗證資料儲存與合約產生來獨立測試。

**Acceptance Scenarios**:

1. **Given** 店員登入系統並有收購單建立權限，**When** 填寫收購單表單（客戶資料、品牌、款式、內碼、數量、金額）並上傳身分證明文件，**Then** 系統驗證表單完整性並建立收購單記錄
2. **Given** 店員選擇線下收購並完成表單填寫，**When** 提交表單，**Then** 系統產生收購合約與一時貿易申請書供店員進行網頁簽名，每次簽名結果即時儲存
3. **Given** 店員選擇線上收購並完成表單填寫，**When** 提交表單，**Then** 系統透過 Dropbox Sign API 將合約文件寄送至客戶 Email 信箱供其簽名
4. **Given** 店員需要新增客戶，**When** 在客戶搜尋欄位輸入後選擇「新增客戶」，**Then** 系統顯示客戶資料表單供填寫，填寫完成後可選擇該客戶繼續建立收購單
5. **Given** 店員上傳或拍照身分證明文件，**When** 點擊自動辨識按鈕（&#10022;），**Then** 系統辨識身分證文字並自動填入客戶資料欄位（姓名、身分證字號等）
6. **Given** 店員已選擇既有客戶並上傳身分證明，**When** 點擊自動辨識按鈕，**Then** 系統比對身分證資料與客戶資料，若不一致則顯示警告訊息

---

### User Story 2 - 建立寄賣單 (Priority: P1)

店員需要快速建立寄賣單以記錄客戶的精品寄賣交易，包含客戶資訊、商品詳情、寄賣金額、寄賣期間與續約設定，並確保寄賣合約完整簽署。

**Why this priority**: 寄賣單與收購單同為核心業務流程，對店鋪營運與客戶服務至關重要。

**Independent Test**: 可透過建立一筆完整的寄賣單（包含客戶選擇、商品資訊、配件、寄賣日期、瑕疵說明、續約設定、身分證明上傳、線下簽名）並驗證資料儲存與合約產生來獨立測試。

**Acceptance Scenarios**:

1. **Given** 店員登入系統並有寄賣單建立權限，**When** 填寫寄賣單表單（包含收購單欄位加上商品配件、寄賣日期、商品瑕疵處、續約設定）並上傳身分證明文件，**Then** 系統驗證表單完整性並建立寄賣單記錄
2. **Given** 店員選擇線下寄賣並完成表單填寫，**When** 提交表單，**Then** 系統產生寄賣合約書供店員進行網頁簽名，簽名結果即時儲存
3. **Given** 店員選擇線上寄賣並完成表單填寫，**When** 提交表單，**Then** 系統透過 Dropbox Sign API 將寄賣合約文件寄送至客戶 Email 信箱供其簽名
4. **Given** 店員選擇寄賣日期，**When** 點擊寄賣日期欄位，**Then** 系統顯示日期區間選擇器供選擇起訖日期
5. **Given** 店員選擇商品配件，**When** 展開配件選項，**Then** 系統顯示多選項目（盒子、防塵袋、購證、提袋、肩帶、羊毛氈、枕頭、保卡、鎖頭/鑰匙、緞帶/花、品牌小卡、保證書、無）
6. **Given** 店員上傳或拍照身分證明文件，**When** 點擊自動辨識按鈕（&#10022;），**Then** 系統辨識身分證文字並自動填入客戶資料欄位

---

### User Story 3 - 客戶搜尋與選擇 (Priority: P2)

店員需要快速搜尋並選擇既有客戶資料，或在找不到客戶時新增客戶資料，以提升服務單建立效率。

**Why this priority**: 此功能優化建單流程，減少重複輸入，但不影響核心建單功能（P1 已包含客戶選擇基礎流程）。

**Independent Test**: 可透過搜尋既有客戶（姓名、電話、Email、身分證字號）、選擇客戶並驗證資料自動填入，或搜尋不到時新增客戶來獨立測試。

**Acceptance Scenarios**:

1. **Given** 店員在服務單表單中，**When** 在客戶搜尋欄位輸入客戶姓名、電話、Email 或身分證字號，**Then** 系統顯示符合條件的客戶列表（包含姓名、電話、Email 等基本資訊）
2. **Given** 店員看到搜尋結果列表，**When** 點擊「選擇」按鈕選擇某位客戶，**Then** 系統自動將該客戶的相關資訊填入服務單表單
3. **Given** 店員搜尋客戶但無符合結果，**When** 選擇「新增客戶」，**Then** 系統顯示新增客戶表單（包含姓名、電話、Email、身分證字號等欄位與身分證文件上傳功能）
4. **Given** 店員完成新增客戶表單填寫，**When** 提交客戶資料，**Then** 系統建立新客戶記錄並自動選擇該客戶於服務單表單

---

### User Story 4 - 服務單查詢與管理 (Priority: P2)

店員需要查詢、瀏覽、修改已建立的收購單與寄賣單，並管理服務單狀態與附件。

**Why this priority**: 查詢與管理功能支援日常營運與客戶服務，但不影響新服務單建立（核心價值）。

**Independent Test**: 可透過搜尋服務單（依類型、客戶名稱、日期範圍等條件）、查看詳細資訊、修改服務單、更新狀態、下載附件來獨立測試。

**Acceptance Scenarios**:

1. **Given** 店員登入系統並有查詢權限，**When** 在查詢介面輸入篩選條件（服務單類型、客戶名稱、日期範圍等），**Then** 系統顯示符合條件的服務單列表（包含服務單編號、客戶名稱、商品資訊、金額、狀態等）
2. **Given** 店員看到服務單列表，**When** 點擊某筆服務單，**Then** 系統顯示該服務單的詳細頁面（包含所有欄位資訊）
3. **Given** 店員在服務單詳細頁面，**When** 修改服務單資訊（如商品資訊、金額等）並儲存，**Then** 系統更新服務單記錄並記錄變更歷史
4. **Given** 店員在服務單詳細頁面，**When** 更新服務單狀態（如「已完成」、「待處理」、「已終止」），**Then** 系統更新狀態並記錄變更時間與操作者
5. **Given** 店員在服務單詳細頁面的附件管理區域，**When** 點擊附件（身分證明、合約文件等），**Then** 系統提供下載連結或預覽功能
6. **Given** 店員查看線上簽名的服務單，**When** 選擇複製 Dropbox Sign 連結或重新寄送簽名邀請，**Then** 系統提供合約連結複製功能或重新透過 Dropbox Sign API 寄送簽名邀請至客戶 Email
7. **Given** 店員需要瀏覽大量服務單，**When** 查看搜尋結果列表，**Then** 系統提供分頁功能以便瀏覽
8. **Given** 店員在服務單查詢結果列表頁面，**When** 點擊「匯出 Excel」按鈕，**Then** 系統將當前畫面顯示的服務單資料匯出為 Excel 檔案並提供下載

---

### Edge Cases

- 若客戶搜尋時輸入多個關鍵字（如同時輸入姓名與電話），系統應採用「且」邏輯搜尋（需同時符合），若無結果則提示放寬搜尋條件。
- 若店員上傳的身分證明文件格式不符（非 JPG、PNG 等圖片格式），系統應拒絕上傳並提示正確格式。
- 若自動辨識身分證功能辨識失敗（如圖片模糊、角度不正確），系統應提示「辨識失敗，請重新拍攝或手動輸入」。
- 若寄賣日期起訖日期設定錯誤（起始日期晚於結束日期），系統應拒絕提交並提示正確的日期範圍。
- 若線上簽名時客戶 Email 無效或無法寄送，系統應記錄錯誤並提示店員確認 Email 或改用線下簽名。
- 若店員嘗試修改已完成或已終止的服務單，系統應根據權限設定決定是否允許修改或僅允許查看。
- 若店員嘗試將「已終止」狀態的服務單轉換為其他狀態，系統應拒絕操作並提示「已終止」狀態為終態，不可逆向轉換。
- 若服務單查詢結果數量超過 1000 筆，系統應限制單次顯示數量並提供分頁或匯出功能。
- 若店員在建立服務單時中途離開（未完成提交），系統應提供草稿儲存功能或提示資料將遺失。
- 若店員匯出 Excel 時當前畫面無任何資料（篩選結果為空），系統應提示「目前無資料可匯出」並不執行匯出動作。
- 若店員匯出的服務單數量超過 10,000 筆，系統應提示「資料量過大，建議縮小篩選範圍」，並限制單次匯出最多 10,000 筆資料。

## Requirements *(mandatory)*

### Functional Requirements

#### 收購單建立

- **FR-001**: 系統必須提供收購單建立表單，包含以下欄位：服務單類型（收購單）、服務單來源（線上/線下）、客戶資料、品牌名稱、款式、內碼、商品數量、金額
- **FR-002**: 系統必須驗證收購單表單的必填欄位（客戶資料、品牌名稱、款式、商品數量、金額）完整性，未填寫完整則不允許提交
- **FR-003**: 系統必須強制要求店員上傳身分證明文件（僅接受圖片格式如 JPG、PNG），未上傳則不允許提交，每次建立服務單都必須上傳（包含既有客戶）
- **FR-004**: 系統必須提供拍照上傳功能，允許店員直接用手機或裝置攝影鏡頭拍攝並上傳身分證明文件
- **FR-005**: 系統必須提供自動辨識身分證功能（&#10022; 按鈕），辨識身分證上的文字並自動填入客戶資料欄位（姓名、身分證字號等）
- **FR-006**: 系統必須在店員已選擇既有客戶後點擊自動辨識時，比對身分證資料與客戶資料是否一致，若不一致則顯示警告訊息
- **FR-007**: 系統必須支援線下收購流程：提交表單後產生收購合約與一時貿易申請書，供客戶進行網頁觸控簽名（可用滑鼠、觸控筆或手指在螢幕上簽名），每次簽名結果即時儲存至後台
- **FR-008**: 系統必須支援線上收購流程：提交表單後透過 Dropbox Sign API 將合約文件寄送至客戶 Email 信箱供客戶簽名
- **FR-009**: 系統必須記錄收購單的建立時間、建立者、修改時間與修改者
- **FR-009-1**: 系統必須自動生成唯一的服務單編號，格式為「類型前綴 + 日期（YYYYMMDD）+ 流水號（3位數）」，收購單前綴為 BS，寄賣單前綴為 CS（如 BS20251214001、CS20251214002）

#### 寄賣單建立

- **FR-010**: 系統必須提供寄賣單建立表單，包含以下欄位：服務單類型（寄賣單）、服務單來源（線上/線下）、客戶資料、品牌名稱、款式、內碼、商品數量、金額、商品配件、寄賣日期、商品瑕疵處、續約設定
- **FR-011**: 系統必須驗證寄賣單表單的必填欄位（客戶資料、品牌名稱、款式、商品數量、金額、寄賣日期、續約設定）完整性，未填寫完整則不允許提交
- **FR-012**: 系統必須提供日期區間選擇器供店員選擇寄賣起訖日期，預設結束日期為起始日期後 3 個月（90 天），並驗證起始日期不得晚於結束日期
- **FR-013**: 系統必須提供商品配件多選功能，選項包含：盒子、防塵袋、購證、提袋、肩帶、羊毛氈、枕頭、保卡、鎖頭/鑰匙、緞帶/花、品牌小卡、保證書、無
- **FR-014**: 系統必須提供商品瑕疵處多選功能，選項包含：五金生鏽/刮痕/掉、皮質磨損/刮痕/壓痕、內裡髒污、四角磨損
- **FR-015**: 系統必須提供續約設定單選功能，選項包含：到期自動取回、第三個月起自動調降 10%、屆時討論
- **FR-016**: 系統必須強制要求店員上傳身分證明文件（僅接受圖片格式如 JPG、PNG），未上傳則不允許提交，每次建立服務單都必須上傳（包含既有客戶）
- **FR-017**: 系統必須提供拍照上傳功能與自動辨識身分證功能（與收購單相同）
- **FR-018**: 系統必須支援線下寄賣流程：提交表單後產生寄賣合約書，供客戶進行網頁觸控簽名（可用滑鼠、觸控筆或手指在螢幕上簽名），簽名結果即時儲存至後台
- **FR-019**: 系統必須支援線上寄賣流程：提交表單後透過 Dropbox Sign API 將寄賣合約文件寄送至客戶 Email 信箱供客戶簽名
- **FR-020**: 系統必須記錄寄賣單的建立時間、建立者、修改時間與修改者
- **FR-020-1**: 系統必須自動生成唯一的寄賣單編號，遵循與收購單相同的編號規則（CS + 日期 + 流水號）

#### 客戶搜尋與選擇

- **FR-021**: 系統必須提供客戶搜尋功能，支援以姓名、電話號碼、Email 或身分證字號作為關鍵字搜尋
- **FR-022**: 系統必須在搜尋結果列表中顯示客戶基本資訊（姓名、電話、Email 等），方便店員辨識
- **FR-023**: 系統必須允許店員從搜尋結果中選擇客戶，並自動將客戶資訊填入服務單表單
- **FR-024**: 系統必須在搜尋無結果時提供「新增客戶」選項，顯示新增客戶表單（包含姓名、電話、Email、身分證字號等欄位與身分證文件上傳功能）
- **FR-025**: 系統必須在店員完成新增客戶後，自動選擇該新客戶並繼續建立服務單流程

#### 服務單查詢與管理

- **FR-026**: 系統必須提供服務單查詢介面，支援以下篩選條件：服務單類型（收購單/寄賣單）、客戶名稱、日期範圍、服務單狀態
- **FR-027**: 系統必須在搜尋結果列表中顯示服務單基本資訊：服務單編號、客戶名稱、商品資訊、金額、狀態、建立日期
- **FR-028**: 系統必須提供分頁功能以便瀏覽大量服務單（每頁顯示筆數可設定，預設為 20 筆）
- **FR-029**: 系統必須允許店員點擊服務單進入詳細頁面，查看完整的服務單資訊
- **FR-030**: 系統必須允許具有修改權限的店員編輯服務單資訊，並儲存變更
- **FR-031**: 系統必須記錄所有服務單的修改歷史，包含修改時間、修改者與修改內容
- **FR-032**: 系統必須提供服務單狀態更新功能，狀態選項包含：待處理、已完成、已終止。狀態轉換規則：「待處理」可轉換為「已完成」或「已終止」；「已完成」可轉回「待處理」；「已終止」為終態不可逆向轉換
- **FR-033**: 系統必須在附件管理區域顯示已上傳的文件（身分證明、合約文件等），並提供下載或預覽功能
- **FR-034**: 系統必須針對線上簽名的服務單，提供複製 Dropbox Sign 合約連結功能
- **FR-035**: 系統必須針對線上簽名的服務單，提供重新寄送簽名邀請功能（透過 Dropbox Sign API）
- **FR-036**: 系統必須提供匯出 Excel 功能，允許店員將當前畫面顯示的服務單查詢結果匯出為 Excel 檔案（.xlsx 格式）
- **FR-037**: 系統必須在 Excel 匯出檔案中包含以下欄位：服務單編號、客戶名稱、品牌名稱、款式、內碼、商品數量、金額、狀態、建立日期，並保持與畫面顯示相同的排序
- **FR-038**: 系統必須在 Excel 檔案名稱中包含匯出時間戳記，格式為「服務單報表_YYYYMMDD_HHMMSS.xlsx」，方便使用者識別與管理

#### 權限管理

- **FR-039**: 系統必須根據使用者權限控制服務單的建立、查詢、修改、刪除功能
- **FR-040**: 系統必須支援以下權限：`serviceOrder.consignment.read`（查詢與匯出寄賣單）、`serviceOrder.consignment.create`（建立寄賣單）、`serviceOrder.consignment.delete`（刪除寄賣單）、`serviceOrder.consignment.update`（修改寄賣單）
- **FR-041**: 系統必須支援收購單相關權限：`serviceOrder.buyback.read`（查詢與匯出收購單）、`serviceOrder.buyback.create`（建立收購單）、`serviceOrder.buyback.delete`（刪除收購單）、`serviceOrder.buyback.update`（修改收購單）

### Key Entities

- **服務單（Service Order）**: 代表收購單或寄賣單的核心實體，包含服務單編號（格式：類型前綴 + 日期 + 流水號，如 BS20251214001 或 CS20251214001）、服務單類型、服務單來源、客戶資料、商品資訊（品牌、款式、內碼、數量）、金額、建立時間、建立者、修改時間、修改者、狀態等屬性。寄賣單額外包含商品配件、寄賣日期、商品瑕疵處、續約設定等屬性。
- **客戶（Customer）**: 代表與店鋪交易的客戶，包含姓名、電話號碼、Email、身分證字號等基本資訊。與服務單為一對多關係（一位客戶可有多筆服務單）。
- **附件（Attachment）**: 代表服務單相關的文件，如身分證明文件、合約文件等，包含檔案名稱、檔案類型、上傳時間、檔案路徑等屬性。與服務單為多對一關係（一筆服務單可有多個附件）。
- **簽名記錄（Signature Record）**: 代表線下或線上簽名的記錄，包含簽名時間、簽名者、簽名文件類型（收購合約、一時貿易申請書、寄賣合約書）、簽名資料（圖片或電子簽名資訊）。與服務單為多對一關係（一筆服務單可有多次簽名記錄）。
- **修改歷史（Modification History）**: 記錄服務單的所有變更，包含修改時間、修改者、修改內容（欄位名稱與變更前後值）。與服務單為多對一關係（一筆服務單可有多筆修改歷史）。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 店員能在 3 分鐘內完成一筆收購單或寄賣單的建立（從開啟表單到提交完成，不含簽名時間）
- **SC-002**: 自動辨識身分證功能的準確率達到 85% 以上（在正常拍攝條件下，如光線充足、角度正確）
- **SC-003**: 客戶搜尋功能能在 1 秒內返回搜尋結果（資料量在 10,000 筆客戶以內）
- **SC-004**: 服務單查詢功能能在 2 秒內返回搜尋結果並顯示第一頁（資料量在 50,000 筆服務單以內）
- **SC-005**: 90% 的店員能在首次使用時成功完成服務單建立流程（包含客戶選擇、表單填寫、附件上傳）
- **SC-006**: 線上簽名功能的合約寄送成功率達到 95% 以上（排除客戶 Email 無效的情況）
- **SC-007**: 系統能同時支援至少 50 位店員同時建立或查詢服務單而不影響效能
- **SC-008**: 減少因資料輸入錯誤導致的服務單修改次數達 40%（透過自動辨識與客戶資料比對功能）
- **SC-009**: Excel 匯出功能能在 5 秒內完成 1,000 筆服務單資料的匯出與下載（在正常網路條件下）
- **SC-010**: 90% 的店員能在首次使用時成功找到並使用 Excel 匯出功能
