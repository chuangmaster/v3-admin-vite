# Feature Specification: 密碼修改 API 調整

**Feature Branch**: `005-password-api-adjustment`  
**Created**: 2026-01-22  
**Status**: Draft  
**Input**: User description: "管理者修改密碼API調整：管理者修改密碼不需要提供舊的密碼；用戶修改密碼API調整：用戶修改密碼需要提供舊的密碼"

## Clarifications

### Session 2026-01-22

- Q: 密碼修改成功後，其他已登入的 session 應如何處理？ → A: JWT 會有 version 版本，如果修改密碼原始的 jwt version 會變，後端會擋住，要求重新登入
- Q: 密碼修改成功後，系統是否需要發送通知給用戶？ → A: 當下告知修改成功就好
- Q: 是否需要防止用戶重複使用最近的舊密碼？ → A: 不需要，僅確保新密碼與當前密碼不同
- Q: 當用戶連續多次輸入錯誤的舊密碼時，系統應如何處理？ → A: 不限制，每次錯誤僅回傳錯誤訊息
- Q: 管理者重設密碼時，是否需要強制用戶在首次登入後必須再次修改密碼？ → A: 不需要，管理者設定的密碼即為正式密碼

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 管理者重設用戶密碼 (Priority: P1)

管理者需要能夠直接為用戶重設密碼，而不需要知道用戶的舊密碼。這是一個常見的支援場景，例如用戶忘記密碼或帳號被鎖定時。

**Why this priority**: 這是最核心的管理功能，管理者必須能夠在用戶無法登入時提供協助。這個功能直接影響客服效率和用戶體驗。

**Independent Test**: 可以通過管理者登入系統，選擇任一用戶，執行密碼重設操作來獨立測試。測試成功後，該用戶應能使用新密碼登入。

**Acceptance Scenarios**:

1. **Given** 管理者已登入系統並選擇一個用戶, **When** 管理者輸入新密碼並提交重設請求, **Then** 系統應成功更新密碼，且不要求提供舊密碼
2. **Given** 管理者提供的新密碼不符合密碼規則, **When** 管理者提交重設請求, **Then** 系統應拒絕請求並顯示密碼規則錯誤訊息
3. **Given** 管理者提供的版本號與資料庫不一致, **When** 管理者提交重設請求, **Then** 系統應拒絕請求並回傳版本衝突錯誤
4. **Given** 管理者重設密碼成功, **When** 用戶使用新密碼登入, **Then** 用戶應能成功登入系統

---

### User Story 2 - 用戶自行修改密碼 (Priority: P1)

用戶需要能夠自行修改密碼，但必須提供舊密碼作為身份驗證，以確保是帳號擁有者本人操作。

**Why this priority**: 這是基本的帳號安全功能，允許用戶主動更新密碼以提升帳號安全性。與管理者重設密碼同等重要。

**Independent Test**: 可以通過用戶登入系統，進入個人設定頁面，輸入舊密碼和新密碼來獨立測試。測試成功後，用戶應能使用新密碼重新登入。

**Acceptance Scenarios**:

1. **Given** 用戶已登入系統並在密碼修改頁面, **When** 用戶輸入正確的舊密碼和符合規則的新密碼, **Then** 系統應成功更新密碼
2. **Given** 用戶輸入錯誤的舊密碼, **When** 用戶提交修改請求, **Then** 系統應拒絕請求並顯示舊密碼錯誤訊息
3. **Given** 用戶的新密碼與舊密碼相同, **When** 用戶提交修改請求, **Then** 系統應拒絕請求並提示新密碼不能與舊密碼相同
4. **Given** 用戶提供的版本號與資料庫不一致, **When** 用戶提交修改請求, **Then** 系統應拒絕請求並回傳版本衝突錯誤
5. **Given** 用戶修改密碼成功, **When** 用戶使用新密碼登入, **Then** 用戶應能成功登入系統

---

### Edge Cases

- 當管理者嘗試為不存在的用戶 ID 重設密碼時，系統應回傳 404 錯誤
- 當用戶在修改密碼期間 session 過期時，系統應要求重新登入
- 當多個管理者同時嘗試重設同一用戶的密碼時，應使用樂觀鎖 (version) 處理並發衝突
- 當用戶連續多次輸入錯誤的舊密碼時，系統僅回傳錯誤訊息，不進行帳號鎖定
- 當密碼包含特殊字元或不同語言字元時，系統應正確處理編碼

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須提供管理者重設用戶密碼的 API 端點 (PUT /api/Account/{id}/reset-password)
- **FR-002**: 管理者重設密碼時，系統不得要求提供用戶的舊密碼
- **FR-003**: 系統必須提供用戶自行修改密碼的 API 端點 (PUT /api/Account/me/password)
- **FR-004**: 用戶自行修改密碼時，系統必須驗證舊密碼的正確性
- **FR-005**: 系統必須驗證新密碼符合密碼強度規則（長度、複雜度等）
- **FR-006**: 系統必須使用樂觀鎖 (version 欄位) 防止並發衝突
- **FR-007**: 系統必須確保新密碼與舊密碼不相同（僅適用於用戶自行修改）
- **FR-008**: 管理者重設密碼的請求必須包含：目標用戶 ID、新密碼、版本號
- **FR-009**: 用戶修改密碼的請求必須包含：舊密碼、新密碼、版本號
- **FR-010**: 系統必須在密碼更新成功後回傳更新的版本號
- **FR-011**: 系統必須記錄所有密碼變更操作的審計日誌（包含操作者、時間、目標用戶）
- **FR-012**: 管理者重設密碼時必須驗證操作者具有管理權限
- **FR-013**: 系統必須在密碼修改成功後更新帳號的 version，使現有的 JWT token 失效

### Assumptions

- 密碼強度規則已在系統中定義（例如：最少 8 個字元，包含大小寫字母和數字）
- 管理者權限驗證機制已存在於系統中
- 樂觀鎖機制已在用戶實體中實作
- 舊密碼驗證使用與登入相同的密碼雜湊比對機制
- API 回應格式遵循現有系統的標準格式
- JWT token 包含 version 欄位，後端會驗證 token 中的 version 與資料庫中的 version 是否一致

### Key Entities

- **Account (帳號)**: 代表系統中的用戶帳號，包含密碼欄位和版本號欄位。密碼修改操作會更新密碼欄位並遞增版本號。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理者能在 30 秒內完成用戶密碼重設操作
- **SC-002**: 用戶能在 1 分鐘內完成自行修改密碼操作
- **SC-003**: 密碼重設和修改操作的 API 回應時間在正常負載下不超過 500 毫秒
- **SC-004**: 100% 的密碼變更操作都被正確記錄在審計日誌中
- **SC-005**: 系統正確拒絕所有不符合密碼規則的新密碼（測試通過率 100%）
- **SC-006**: 系統正確拒絕所有舊密碼錯誤的用戶修改請求（測試通過率 100%）
- **SC-007**: 並發密碼修改操作能正確使用樂觀鎖處理，避免資料不一致（衝突檢測率 100%）
- **SC-008**: 密碼修改成功後，用戶能立即使用新密碼登入（成功率 100%）
