# Feature Specification: 線上簽章請求

**Feature Branch**: `005-online-signature`  
**Created**: 2026-01-10  
**Status**: Draft  
**Input**: 服務單管理模組 - 線上表單簽章請求功能，讓客戶能夠在線上完成簽名

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 發送簽章請求給線上客戶 (Priority: P1)

當服務人員建立收購單或寄賣單後，如果客戶來自線上渠道，服務人員需要發送簽章請求給客戶，讓客戶能夠在線上完成合約簽署。

**Why this priority**: 這是核心功能，沒有這個功能就無法讓線上客戶完成簽名流程，是整個線上簽章功能的基礎。

**Independent Test**: 服務人員可以在服務單詳情頁面點擊「發送簽章請求」按鈕，系統會生成簽章連結並發送給客戶，服務人員可以看到簽章狀態更新為「已發送」。

**Acceptance Scenarios**:

1. **Given** 服務人員已建立一張線上客戶的服務單（收購單或寄賣單），**When** 在服務單詳情頁面的簽名紀錄區塊點擊「發送簽章請求」按鈕，**Then** 系統生成簽章連結並顯示成功訊息「簽章請求已成功發送」
2. **Given** 簽章請求已成功發送，**When** 頁面重新載入服務單詳情，**Then** 簽名紀錄區塊顯示簽章狀態、發送時間、到期時間，並顯示「重新發送簽章請求」和「複製簽章連結」按鈕
3. **Given** 簽章請求已發送但客戶尚未簽署，**When** 服務人員查看簽章狀態，**Then** 狀態顯示為「待簽署」或「已發送」（非 SIGNED 狀態）

---

### User Story 2 - 重新發送簽章請求 (Priority: P2)

當客戶遺失簽章連結或連結過期時，服務人員需要能夠重新發送簽章請求給客戶。

**Why this priority**: 處理常見的異常情況，提升用戶體驗，但不是初始流程的必要功能。

**Independent Test**: 在已發送但未完成簽署的服務單中，點擊「重新發送簽章請求」按鈕，系統會重新生成並發送新的簽章連結。

**Acceptance Scenarios**:

1. **Given** 簽章請求已發送但簽章狀態不是 SIGNED，**When** 服務人員點擊「重新發送簽章請求」按鈕，**Then** 系統生成新的簽章連結並更新簽章紀錄
2. **Given** 簽章連結已過期，**When** 服務人員重新發送簽章請求，**Then** 系統生成新的有效簽章連結，到期時間重新計算為 30 天後

---

### User Story 3 - 複製簽章連結 (Priority: P2)

服務人員需要能夠直接複製簽章連結，以便透過其他通訊管道（如 LINE、Email、簡訊）分享給客戶。

**Why this priority**: 提供彈性的連結分享方式，但不是必須功能（系統可以自動發送）。

**Independent Test**: 點擊「複製簽章連結」按鈕後，連結被複製到剪貼簿，可以貼到其他應用程式中。

**Acceptance Scenarios**:

1. **Given** 簽章請求已發送且簽章連結存在，**When** 服務人員點擊「複製簽章連結」按鈕，**Then** 簽章連結被複製到剪貼簿，並顯示「連結已複製」的提示訊息
2. **Given** 連結已複製到剪貼簿，**When** 服務人員貼到其他應用程式，**Then** 完整的簽章 URL 被正確貼上

---

### User Story 4 - 查看簽章狀態 (Priority: P1)

服務人員需要能夠即時查看客戶的簽章狀態，了解客戶是否已完成簽署。

**Why this priority**: 核心功能，服務人員需要知道簽章流程的進度才能進行後續作業。

**Independent Test**: 在服務單詳情頁面的簽名紀錄區塊，可以清楚看到簽章狀態（待簽署、已簽署等）。

**Acceptance Scenarios**:

1. **Given** 簽章請求已發送，**When** 服務人員查看服務單詳情，**Then** 簽名紀錄區塊顯示當前簽章狀態（如：待簽署、已簽署、已過期）
2. **Given** 客戶已完成線上簽署，**When** 服務人員重新整理或開啟服務單詳情，**Then** 簽章狀態更新為「SIGNED」，且「重新發送簽章請求」按鈕被隱藏或停用

---

### Edge Cases

- 如果簽章請求發送失敗（API 錯誤或網路問題），系統應顯示錯誤訊息，並允許服務人員重試
- 如果客戶在簽章連結過期後才嘗試簽署，系統應提示連結已過期，並引導客戶聯絡服務人員
- 如果服務單類型不是收購單或寄賣單，不應顯示「發送簽章請求」按鈕
- 如果客戶來源不是線上渠道，不應顯示線上簽章相關功能
- 如果簽章已完成（狀態為 SIGNED），不應允許重新發送簽章請求

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須在服務單詳情頁面的簽名紀錄區塊提供「發送簽章請求」按鈕，僅當服務單來源為線上渠道時顯示
- **FR-002**: 系統必須能夠發送簽章請求給客戶
- **FR-003**: 系統必須在發送成功後顯示簽章狀態、發送時間、到期時間和簽章連結
- **FR-004**: 系統必須在簽章狀態不是 SIGNED 時，顯示「重新發送簽章請求」按鈕
- **FR-005**: 系統必須提供「複製簽章連結」按鈕，點擊後將簽章 URL 複製到剪貼簿
- **FR-006**: 系統必須在發送簽章請求後重新取得完整的服務單詳情，以更新簽章狀態
- **FR-007**: 系統必須顯示 API 回傳的成功訊息或錯誤訊息給使用者
- **FR-008**: 系統必須處理 API 錯誤情況，並提供使用者友善的錯誤提示
- **FR-009**: 系統必須支援收購單（BUYBACK）和寄賣單類型的線上簽章
- **FR-010**: 系統必須記錄每次簽章請求的唯一識別碼，以便追蹤和管理

### Key Entities

- **簽章紀錄（Signature Record）**: 記錄每次簽章請求的詳細資訊
  - 簽章紀錄 ID: 系統內部識別碼
  - 簽章連結: 客戶用來簽署的 URL
  - 發送時間: 簽章請求發送的時間戳記
  - 到期時間: 簽章連結的有效期限
  - 簽章狀態: 如已簽署、待簽署、已過期等

- **服務單（Service Order）**: 需要客戶簽署的收購單或寄賣單
  - 服務單 ID（serviceOrderId）: 用於 API 請求的識別碼
  - 服務單類型: 收購單或寄賣單
  - 客戶來源: 線上或線下渠道

- **合約文件**: 需要客戶簽署的合約類型
  - BUYBACK_CONTRACT_WITH_ONE_TIME_TRADE: 收購合約（含一次性交易）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 服務人員可以在 10 秒內完成發送簽章請求的操作（從點擊按鈕到看到成功訊息）
- **SC-002**: 簽章狀態在服務單詳情頁面自動更新，服務人員能即時看到最新狀態
- **SC-003**: 95% 的簽章請求能夠成功發送
- **SC-004**: 複製簽章連結功能在所有主流瀏覽器（Chrome、Firefox、Edge、Safari）上正常運作
- **SC-005**: 使用者能夠清楚區分不同的簽章狀態（待簽署、已簽署、已過期等）
- **SC-006**: 錯誤情況下，系統提供明確的錯誤訊息，使用者知道如何處理問題
