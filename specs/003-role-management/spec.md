# Feature Specification: 角色管理系統

**Feature Branch**: `003-role-management`
**Created**: 2025-11-20
**Status**: Draft
**Input**: User description: "建立一個管理角色的列表，包含新增、刪除、修改、匯出報表，並且可以在既有的用戶管理頁面分配角色，同時角色頁面可以設定權限"

## Clarifications

### Session 2025-11-20

- Q: 當角色正在被用戶使用時，刪除操作的具體行為 → A: 後端應該會阻止刪除
- Q: 角色權限設定的介面形式 → A: 在角色編輯對話框內嵌權限設定區域（折疊面板或分頁）
- Q: 角色列表的預設排序欄位和順序 → A: 按建立時間降序（最新建立的在前），但列表提供排序功能
- Q: 用戶表單中角色選擇器的具體呈現方式 → A: 下拉式多選選擇器（支援搜尋和快速選擇）
- Q: 權限列表的具體分組結構和展示形式 → A: 存取控制（Access Control）├── 使用者管理 ├── 角色管理 ├── 權限管理

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 角色基本管理 (Priority: P1)

系統管理員需要建立和管理組織內的角色，以便將相同職責的用戶群組化管理。管理員可以新增、編輯、刪除角色，並查看所有角色列表。

**Why this priority**: 這是核心功能，沒有角色就無法進行後續的權限設定和用戶分配，是整個功能的基礎。

**Independent Test**: 可以透過建立一個新角色（例如「編輯者」）、修改其名稱或描述、刪除該角色來獨立測試，不依賴其他功能。

**Acceptance Scenarios**:

1. **Given** 管理員登入系統並進入角色管理頁面，**When** 點擊「新增角色」按鈕並填寫角色名稱（必填）和角色描述（選填）後提交，**Then** 系統成功建立角色並顯示在角色列表中，包含完整的名稱和描述資訊
2. **Given** 角色列表中存在一個角色，**When** 管理員點擊編輯按鈕並修改角色名稱或描述後保存，**Then** 系統更新角色資訊並在列表中反映變更
3. **Given** 管理員正在編輯角色資訊，**When** 該角色同時被另一個管理員修改，**Then** 系統透過樂觀鎖機制偵測並發衝突，拒絕後者的修改並提示「資料已被其他用戶更新，請重新載入後再試」
4. **Given** 角色列表中存在一個未被任何用戶使用的角色，**When** 管理員點擊刪除按鈕並確認，**Then** 系統驗證樂觀鎖版本後刪除該角色並從列表中移除
5. **Given** 系統中存在多個角色，**When** 管理員進入角色管理頁面，**Then** 系統顯示所有角色的列表（預設按建立時間降序排列），包含名稱、描述、建立時間、更新時間等資訊，並提供欄位排序功能

---

### User Story 2 - 角色權限設定 (Priority: P2)

系統管理員需要為每個角色設定具體的權限，以控制該角色能夠執行的操作範圍。管理員可以在角色編輯對話框內透過折疊面板或分頁形式勾選或取消勾選各項權限。

**Why this priority**: 在能夠建立角色後，設定權限是讓角色發揮作用的關鍵步驟，這使得角色管理具有實際意義。

**Independent Test**: 建立一個測試角色，為其分配特定權限（如「查看用戶」和「編輯用戶」），然後驗證權限是否正確保存和顯示。

**Acceptance Scenarios**:

1. **Given** 管理員進入某個角色的編輯對話框並展開權限設定區域，**When** 勾選或取消勾選權限項目後保存，**Then** 系統更新該角色的權限配置
2. **Given** 某個角色已設定特定權限，**When** 管理員再次進入該角色的編輯對話框，**Then** 系統正確顯示該角色當前已分配的權限（已勾選狀態）
3. **Given** 管理員在角色編輯對話框的權限設定區域，**When** 查看可用權限列表，**Then** 系統以樹狀分組結構展示所有可分配的權限（頂層為「存取控制（Access Control）」，下層包含「使用者管理」、「角色管理」、「權限管理」等功能模組，每個模組下列出具體權限項目）

---

### User Story 3 - 用戶角色分配 (Priority: P2)

系統管理員需要在用戶管理頁面為用戶分配一個或多個角色，使用戶繼承角色的權限。管理員可以在新增或編輯用戶時透過下拉式多選選擇器（支援搜尋）選擇角色。

**Why this priority**: 角色與用戶的關聯是實現權限控制的實際應用場景，與權限設定同等重要。

**Independent Test**: 在用戶管理頁面編輯一個用戶，為其分配「管理員」角色，保存後驗證用戶資訊中是否正確顯示該角色。

**Acceptance Scenarios**:

1. **Given** 管理員在用戶管理頁面新增或編輯用戶，**When** 在下拉式多選角色選擇器中選擇一個或多個角色後保存，**Then** 系統將選定的角色分配給該用戶
2. **Given** 用戶已被分配角色，**When** 管理員在用戶管理頁面查看該用戶資訊，**Then** 系統在角色選擇器中顯示該用戶當前擁有的所有角色（已選中狀態）
3. **Given** 管理員編輯某個用戶的角色分配，**When** 在角色選擇器中移除該用戶的某個角色後保存，**Then** 系統更新用戶的角色配置並移除對應的角色關聯

---

### User Story 4 - 角色資料匯出 (Priority: P3)

系統管理員需要將角色列表資料匯出為 Excel 報表，以便進行離線分析、備份或向上級匯報。

**Why this priority**: 這是輔助功能，提升管理便利性，但不影響核心角色管理功能的運作。

**Independent Test**: 在角色管理頁面點擊「匯出報表」按鈕，驗證是否成功下載包含所有角色資訊的 Excel 檔案。

**Acceptance Scenarios**:

1. **Given** 管理員在角色管理頁面（無篩選條件），**When** 點擊「匯出報表」按鈕，**Then** 系統生成包含所有角色資訊的 Excel 檔案並觸發下載
2. **Given** 匯出的 Excel 檔案，**When** 管理員開啟檔案，**Then** 檔案包含角色名稱、描述、建立時間、更新時間等完整資訊
3. **Given** 角色列表有搜尋或篩選條件，**When** 管理員點擊匯出，**Then** 系統僅匯出當前篩選後顯示的角色資料，並在 UI 上顯示匯出的資料筆數提示

---

### Edge Cases

- **角色刪除限制**: 當角色已被分配給用戶時，後端系統必須阻止刪除操作並返回錯誤，前端顯示錯誤訊息「該角色正在使用中，無法刪除」。管理員需要先手動解除所有用戶的該角色分配後才能刪除角色。
- **角色名稱重複**: 當管理員嘗試建立或修改角色時使用已存在的角色名稱，系統應提示錯誤並要求使用唯一名稱。
- **並發修改衝突（樂觀鎖）**: 當多個管理員同時編輯同一個角色時，系統透過樂觀鎖（版本號或時間戳）偵測並發衝突。後提交的修改會被拒絕，系統提示用戶重新載入最新資料後再進行編輯。
- **並發刪除衝突（樂觀鎖）**: 當管理員嘗試刪除角色時，若該角色的版本已被其他操作更新，系統拒絕刪除並提示用戶重新載入最新狀態。
- **角色描述長度限制**: 角色描述欄位的最大長度限制（假設：500 字元），超過時系統提示錯誤。
- **權限變更影響**: 當某個角色的權限被修改後，已擁有該角色的用戶權限應立即生效還是需要重新登入？（假設：立即生效）
- **用戶多角色權限**: 當用戶被分配多個角色且這些角色的權限有重疊或衝突時，系統如何處理？（假設：採用權限聯集，只要任一角色擁有該權限即可）
- **空資料匯出**: 當系統中沒有任何角色時，匯出報表功能應如何回應？（假設：生成空的 Excel 檔案或提示「暫無資料可匯出」）
- **大量角色效能**: 當系統中存在大量角色（例如超過 100 個）時，角色列表載入和搜尋效能是否需要分頁或虛擬滾動？（假設：採用分頁機制）

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系統必須提供角色管理頁面，顯示所有角色的列表，包含角色名稱、角色描述、建立時間、更新時間，預設按建立時間降序排列，並支援按各欄位進行排序
- **FR-002**: 系統必須允許具有權限的管理員新增角色，要求輸入角色名稱（必填，不可重複）和角色描述（選填，最大 500 字元）
- **FR-003**: 系統必須允許具有權限的管理員編輯現有角色的名稱和描述
- **FR-004**: 系統必須允許具有權限的管理員刪除角色，但需先驗證該角色是否正在被用戶使用
- **FR-005**: 系統必須在嘗試刪除正在使用的角色時，由後端阻止操作並返回錯誤，前端顯示錯誤訊息「該角色正在使用中，無法刪除」
- **FR-006**: 系統必須驗證角色名稱的唯一性，不允許建立重複名稱的角色
- **FR-017**: 系統必須為所有角色實體實作樂觀鎖機制（版本號或時間戳），用於偵測並發修改衝突
- **FR-018**: 系統必須在角色的新增、修改、刪除操作中驗證樂觀鎖版本，確保資料一致性
- **FR-019**: 系統必須在偵測到樂觀鎖衝突時拒絕操作並向用戶顯示明確的錯誤訊息（例如：「資料已被其他用戶更新，請重新載入後再試」）
- **FR-020**: 系統必須在角色列表的查詢操作中返回當前的樂觀鎖版本資訊，供後續修改或刪除操作使用
- **FR-007**: 系統必須在角色編輯對話框內提供權限設定功能（透過折疊面板或分頁形式），允許管理員為角色勾選或取消勾選權限項目
- **FR-008**: 系統必須以樹狀分組結構展示可分配的權限列表，頂層為「存取控制（Access Control）」，下層按功能模組分組（如「使用者管理」、「角色管理」、「權限管理」），每個模組下列出具體權限項目
- **FR-009**: 系統必須儲存角色與權限的關聯關係，並在角色編輯對話框中正確顯示已分配的權限
- **FR-010**: 系統必須在用戶管理頁面的新增/編輯用戶表單中提供下拉式多選角色選擇器，支援搜尋和快速選擇功能
- **FR-011**: 系統必須允許為單一用戶分配一個或多個角色
- **FR-012**: 系統必須在用戶管理頁面的用戶列表中顯示每個用戶的角色資訊
- **FR-013**: 系統必須支援移除用戶已分配的角色
- **FR-014**: 系統必須提供角色列表匯出功能，生成包含當前顯示（篩選後）角色資訊的 Excel 檔案，並在匯出前或匯出時顯示資料筆數
- **FR-015**: 系統必須在角色管理頁面提供搜尋功能，允許按角色名稱或描述進行搜尋
- **FR-016**: 系統必須實作角色管理相關操作的權限控制（新增、編輯、刪除角色需要對應權限）

### Key Entities

- **角色 (Role)**: 代表一組權限的集合，用於群組化管理具有相同職責的用戶。關鍵屬性包括：角色名稱（必填，唯一，字串）、角色描述（選填，字串，最大 500 字元）、樂觀鎖版本（整數或時間戳，用於並發控制）、建立時間、更新時間。與權限實體為多對多關係，與用戶實體為多對多關係。
- **權限 (Permission)**: 代表系統中可執行的具體操作或可訪問的資源。關鍵屬性包括：權限代碼（唯一）、權限名稱、所屬模組/分類。與角色實體為多對多關係。
- **用戶 (User)**: 系統使用者，可被分配一個或多個角色以獲得權限。與角色實體為多對多關係（此關係已在既有用戶管理功能中存在，本功能擴展此關係）。
- **角色權限關聯 (Role-Permission)**: 記錄角色與權限之間的多對多關聯關係。
- **用戶角色關聯 (User-Role)**: 記錄用戶與角色之間的多對多關聯關係，可能包含分配時間等額外資訊。

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 管理員能夠在 30 秒內完成新角色的建立和基本權限配置
- **SC-002**: 系統能夠在 2 秒內載入包含 100 個角色的列表頁面
- **SC-003**: 管理員能夠在 3 次點擊內完成為用戶分配角色的操作
- **SC-004**: 角色權限變更後，受影響用戶的權限在 5 秒內生效（無需重新登入）
- **SC-005**: 角色管理頁面的搜尋功能能在 1 秒內返回結果
- **SC-006**: 匯出包含 100 個角色資料的 Excel 報表在 10 秒內完成
- **SC-007**: 90% 的管理員能在首次使用時無需協助即可成功建立角色並設定權限
- **SC-008**: 系統能夠支援至少 50 個並發管理員同時進行角色管理操作而不出現效能降級

## Assumptions _(mandatory)_

- 系統已存在用戶管理功能（參考 `src/pages/user-management/index.vue`）
- 系統已存在權限管理功能和權限常數定義（參考 `src/common/constants/permissions.ts`）
- 角色名稱採用唯一性約束，不區分大小寫
- 角色描述欄位最大長度為 500 字元
- 用戶可被分配多個角色，最終權限為所有角色權限的聯集
- 角色權限變更即時生效，不需要用戶重新登入
- 預設使用分頁機制處理大量角色資料，每頁顯示 10/20/50/100 筆可選
- 角色刪除採用軟刪除機制，實際資料保留以供審計
- 匯出報表功能匯出當前搜尋/篩選條件下的角色資料
- Excel 匯出格式採用 `.xlsx`，包含表頭和資料行，包含角色名稱、描述等完整資訊
- 角色管理功能遵循專案既有的 RBAC（角色基礎存取控制）權限模型
- 樂觀鎖採用版本號機制（整數型別），每次更新後版本號自動遞增
- 樂觀鎖衝突時採用「失敗快速」策略，拒絕後續操作並要求用戶重新載入
- 查詢操作不需要驗證樂觀鎖，但需要返回當前版本號供後續操作使用

## Dependencies

- 依賴既有的用戶管理模組（`src/pages/user-management`）
- 依賴既有的權限管理模組（`src/pages/permission-management`）
- 依賴既有的權限常數定義（`src/common/constants/permissions.ts`）
- 依賴 Element Plus UI 元件庫提供表格、表單、對話框等元件
- 依賴專案既有的 Excel 匯出工具（參考用戶管理的 `useExportExcel` composable）
- 依賴專案既有的 HTTP 請求封裝（`src/http/axios.ts`）
- 依賴專案既有的權限指令（`src/plugins/permission-directive.ts`）

## Out of Scope

- 角色繼承功能（例如角色 A 繼承角色 B 的所有權限）
- 動態權限系統（本功能僅處理預定義的靜態權限）
- 角色使用情況統計和分析報表
- 角色審計日誌和變更歷史追蹤（僅記錄建立和更新時間）
- 批量角色操作（如批量刪除、批量匯入）
- 角色模板功能
- 細粒度權限控制（如資料層級權限、欄位級權限）
- 角色有效期限制（時效性角色）
- 角色審批流程
