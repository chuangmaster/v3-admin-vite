# Feature Specification: 權限管理系統

**Feature Branch**: `002-permission-management`
**Created**: 2025-11-18
**Status**: Draft
**Input**: User description: "建立一個管理權限的功能,可以新增刪除修改權限,並提供一個管理介面"

## 系統架構上下文

本功能是存取控制（Access Control）體系的一部分，系統採用三層權限架構：

```
存取控制（Access Control）
├── 使用者管理 (Users)
│    ├── 使用者列表
│    └── 使用者編輯（含 userRole 關聯）
│
├── 角色管理 (Roles)
│    ├── 角色列表
│    └── 角色編輯（含 permissionRole 關聯）
│
└── 權限管理 (Permissions) ← 本規格範圍
     ├── 權限列表
     └── 權限編輯
```

**權限流向**: 使用者 → 被指派角色 → 角色包含權限 → 權限定義具體操作

**本功能定位**: 權限管理是存取控制的基礎層，負責定義系統中所有可執行的操作。這些權限會被角色管理功能引用，最終透過角色分配給使用者。

## Clarifications

### Session 2025-11-19

- Q: 權限清單每頁應顯示多少筆資料？ → A: 每頁 20 筆
- Q: 當多位管理員同時編輯同一權限時,系統應如何處理衝突？ → A: 使用樂觀鎖定(版本號),衝突時拒絕提交並要求重新載入
- Q: 權限代碼的格式驗證應該有多嚴格？ → A: module:action 格式，允許多層級但最多三層（如 user:profile:edit）

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 瀏覽與查詢權限 (Priority: P1)

系統管理員需要查看系統中所有權限的清單，以了解目前有哪些權限可供分配。管理員可以透過搜尋功能快速找到特定權限，並查看權限的詳細資訊（如權限名稱、描述、關聯功能等）。

**Why this priority**: 這是最基礎的功能，管理員必須先能看到現有權限才能進行管理操作。這是所有其他操作的前提。

**Independent Test**: 管理員登入系統後進入權限管理頁面，能看到完整的權限列表並使用搜尋功能，即可驗證此功能獨立運作。

**Acceptance Scenarios**:

1. **Given** 管理員已登入系統，**When** 進入權限管理頁面，**Then** 顯示所有權限的清單，包含權限名稱、權限代碼、描述、建立時間等資訊
2. **Given** 權限清單已載入，**When** 在搜尋框輸入關鍵字，**Then** 即時過濾顯示符合的權限項目
3. **Given** 權限清單中有多筆資料，**When** 點擊某個權限項目，**Then** 顯示該權限的完整詳細資訊
4. **Given** 權限清單資料超過一頁，**When** 切換分頁，**Then** 正確載入並顯示對應頁面的權限資料

---

### User Story 2 - 新增權限 (Priority: P2)

系統管理員可以建立新的權限項目，輸入權限名稱、權限代碼、描述等基本資訊。新建立的權限會立即出現在權限清單中，並可供角色管理功能選用，最終透過角色分配給使用者。

**Why this priority**: 新增功能是擴充系統權限的核心需求，優先級僅次於瀏覽功能。新權限建立後才能被角色引用。

**Independent Test**: 管理員在權限管理介面點擊「新增權限」按鈕，填寫完整資訊並儲存，檢查新權限是否成功建立並出現在清單中。

**Acceptance Scenarios**:

1. **Given** 管理員在權限管理頁面，**When** 點擊「新增權限」按鈕，**Then** 開啟新增權限表單
2. **Given** 新增權限表單已開啟，**When** 輸入必填欄位（權限名稱、權限代碼）並提交，**Then** 成功建立權限並顯示成功訊息
3. **Given** 新增權限表單已開啟，**When** 輸入的權限代碼已存在，**Then** 顯示錯誤訊息「權限代碼已存在」並阻止提交
4. **Given** 新增權限表單已開啟，**When** 未填寫必填欄位並嘗試提交，**Then** 顯示欄位驗證錯誤訊息
5. **Given** 新增權限表單已開啟，**When** 點擊取消按鈕，**Then** 關閉表單並放棄新增操作

---

### User Story 3 - 編輯權限 (Priority: P2)

系統管理員可以修改現有權限的資訊，包括權限名稱、描述等屬性。編輯後的資訊會立即更新並反映在權限清單中。

**Why this priority**: 編輯功能讓管理員能夠維護權限資訊的準確性，與新增功能同等重要。

**Independent Test**: 管理員選擇一個現有權限，修改其資訊並儲存，檢查修改是否成功套用。

**Acceptance Scenarios**:

1. **Given** 管理員在權限清單頁面，**When** 點擊某個權限的「編輯」按鈕，**Then** 開啟編輯表單並預填該權限的現有資訊
2. **Given** 編輯權限表單已開啟，**When** 修改權限名稱或描述並提交，**Then** 成功更新權限資訊並顯示成功訊息
3. **Given** 編輯權限表單已開啟，**When** 修改權限代碼為已存在的代碼，**Then** 顯示錯誤訊息「權限代碼已存在」並阻止提交
4. **Given** 編輯權限表單已開啟，**When** 清空必填欄位並嘗試提交，**Then** 顯示欄位驗證錯誤訊息
5. **Given** 編輯權限表單已開啟，**When** 點擊取消按鈕，**Then** 關閉表單並放棄修改操作

---

### User Story 4 - 刪除權限 (Priority: P3)

系統管理員可以刪除不再需要的權限。刪除前系統會提示確認，刪除後權限會從清單中移除。

**Why this priority**: 刪除功能是維護系統整潔的重要功能，但優先級低於新增和編輯，因為刪除操作相對較少發生。

**Independent Test**: 管理員選擇一個未被使用的權限並執行刪除操作，確認該權限從清單中消失。

**Acceptance Scenarios**:

1. **Given** 管理員在權限清單頁面，**When** 點擊某個權限的「刪除」按鈕，**Then** 顯示確認刪除的對話框
2. **Given** 刪除確認對話框已顯示，**When** 點擊確認刪除，**Then** 成功刪除權限並從清單中移除，顯示成功訊息
3. **Given** 刪除確認對話框已顯示，**When** 點擊取消，**Then** 關閉對話框並不執行刪除操作
4. **Given** 某個權限已被角色使用（透過 permissionRole 關聯），**When** 嘗試刪除該權限，**Then** 顯示錯誤訊息「該權限已被 N 個角色使用，無法刪除」並阻止刪除

---

### User Story 5 - 批次操作權限 (Priority: P4)

系統管理員可以同時選擇多個權限進行批次操作，如批次刪除、批次匯出等，提升管理效率。

**Why this priority**: 批次操作是進階功能，能提升效率但非核心需求，因此優先級較低。

**Independent Test**: 管理員在權限清單中勾選多個權限項目，執行批次刪除操作，確認所有選中的權限都被刪除。

**Acceptance Scenarios**:

1. **Given** 管理員在權限清單頁面，**When** 勾選多個權限項目，**Then** 顯示批次操作按鈕（如批次刪除）
2. **Given** 已勾選多個權限項目，**When** 點擊批次刪除按鈕，**Then** 顯示確認對話框列出要刪除的權限
3. **Given** 批次刪除確認對話框已顯示，**When** 點擊確認，**Then** 成功刪除所有選中的權限並顯示成功訊息
4. **Given** 批次刪除確認對話框已顯示，**When** 點擊取消，**Then** 關閉對話框並不執行刪除操作
5. **Given** 選中的權限中有部分正在使用中，**When** 執行批次刪除，**Then** 僅刪除未使用的權限，並提示哪些權限因使用中而無法刪除

---

### Edge Cases

- 當權限清單為空時，顯示空狀態提示「目前沒有權限，請新增」
- 當網路請求失敗時，顯示錯誤訊息並提供重試選項
- 當嘗試刪除系統內建的核心權限時，顯示警告訊息並阻止刪除
- 當嘗試刪除已被角色使用的權限時，顯示該權限被哪些角色使用，並建議先從角色中移除
- 當同時有多位管理員編輯同一個權限時，使用樂觀鎖定機制(版本號),後提交的編輯若偵測到版本衝突則拒絕提交,顯示錯誤訊息並要求使用者重新載入最新資料
- 當輸入的權限代碼包含特殊字元或不符合命名規範時，顯示格式錯誤提示（必須符合 module:action 格式，允許最多三層，例如 user:create、user:profile:edit）
- 當權限名稱或描述超過字元數限制時，顯示驗證錯誤
- 當分頁載入時間過長，顯示載入指示器避免使用者重複操作
- 當查看某個權限時，顯示該權限目前被哪些角色使用（透過 permissionRole 關聯）

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系統必須提供權限清單檢視功能，顯示所有權限的基本資訊（權限名稱、權限代碼、描述、建立時間、更新時間）
- **FR-002**: 系統必須提供權限搜尋功能，支援透過權限名稱或權限代碼進行即時過濾
- **FR-003**: 系統必須提供分頁功能，每頁顯示 20 筆權限資料，當權限數量超過 20 筆時自動分頁
- **FR-004**: 系統必須提供新增權限功能，要求輸入權限名稱（必填）、權限代碼（必填、唯一）、描述（選填）
- **FR-005**: 系統必須驗證權限代碼的唯一性，不允許建立重複的權限代碼
- **FR-006**: 系統必須驗證必填欄位，在提交前檢查所有必填欄位是否已填寫
- **FR-007**: 系統必須提供編輯權限功能，允許修改權限名稱、描述等資訊
- **FR-008**: 系統必須在編輯表單中預填現有權限資訊，方便管理員修改
- **FR-009**: 系統必須提供刪除權限功能，並在刪除前顯示確認對話框
- **FR-010**: 系統必須檢查權限使用狀態，禁止刪除正在被角色使用的權限（透過 permissionRole 關聯表檢查）
- **FR-011**: 系統必須提供批次選擇功能，允許同時選中多個權限項目
- **FR-012**: 系統必須提供批次刪除功能，能同時刪除多個未使用的權限
- **FR-013**: 系統必須記錄權限的建立時間和最後更新時間
- **FR-014**: 系統必須在所有操作成功或失敗後顯示明確的提示訊息
- **FR-015**: 系統必須保護系統內建的核心權限，禁止刪除或修改關鍵屬性
- **FR-016**: 系統必須支援權限代碼格式驗證，確保符合 module:action 格式且最多三層（例如 user:create、user:profile:edit），僅允許英數字、底線、冒號
- **FR-017**: 系統必須限制權限名稱和描述的最大字元數（建議：名稱 100 字元，描述 500 字元）
- **FR-018**: 系統必須僅允許具有管理員權限的使用者存取權限管理功能
- **FR-019**: 系統必須記錄所有權限管理操作的審計日誌（新增、修改、刪除操作的時間、操作人、操作內容）
- **FR-020**: 系統必須在表單驗證失敗時，明確指出哪些欄位存在問題及錯誤原因
- **FR-021**: 系統必須提供檢視權限使用情況的功能，顯示該權限被哪些角色使用（透過 permissionRole 關聯）
- **FR-022**: 系統刪除權限時，必須先檢查是否存在 permissionRole 關聯，若有則阻止刪除並提示使用者
- **FR-023**: 系統必須使用樂觀鎖定機制(版本號)處理並行編輯,當偵測到版本衝突時拒絕提交並顯示錯誤訊息「資料已被其他使用者修改,請重新載入」
- **FR-024**: 系統必須在每次成功更新權限時自動遞增版本號

### Key Entities

- **權限 (Permission)**: 代表系統中的一個操作權限，包含以下屬性：
  - 權限 ID（唯一識別碼）
  - 權限名稱（顯示名稱，例如「新增使用者」、「編輯角色」）
  - 權限代碼（唯一的程式碼識別碼，格式：module:action 最多三層，例如「user:create」、「user:profile:edit」）
  - 權限描述（說明此權限的用途）
  - 是否為系統內建權限（標記是否可刪除）
  - 版本號（用於樂觀鎖定,防止並行編輯衝突）
  - 建立時間
  - 更新時間
  - 建立者（操作的管理員）
  - 最後更新者

- **角色權限關聯 (PermissionRole)**: 關聯權限與角色的中介表（由角色管理功能維護），包含：
  - 權限 ID
  - 角色 ID
  - 關聯時間
  - 備註：權限管理功能需要查詢此關聯以判斷權限是否正在使用

- **操作日誌 (Audit Log)**: 記錄權限管理的所有操作歷史，包含：
  - 日誌 ID
  - 操作類型（新增、修改、刪除）
  - 操作對象（權限 ID 和名稱）
  - 操作人（管理員 ID 和名稱）
  - 操作時間
  - 變更內容（修改前後的值）

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 管理員能在 5 秒內完成新增一個權限的操作（從點擊新增按鈕到提交成功）
- **SC-002**: 權限清單能在 2 秒內載入並顯示完整資料（在 1000 筆權限以內）
- **SC-003**: 搜尋功能能在 500 毫秒內回應並顯示過濾結果
- **SC-004**: 系統能同時支援至少 20 位管理員進行權限管理操作而不影響效能
- **SC-005**: 所有表單驗證錯誤訊息必須在使用者提交後立即顯示（不超過 200 毫秒）
- **SC-006**: 95% 的管理員能在首次使用時不需查閱文件就能成功完成新增、編輯、刪除權限操作
- **SC-007**: 批次刪除操作能在 3 秒內完成（10 個權限以內）
- **SC-008**: 系統必須記錄 100% 的權限管理操作到審計日誌，無遺漏
- **SC-009**: 錯誤處理覆蓋率達到 100%，所有可能的錯誤情況都有對應的使用者友善提示訊息
- **SC-010**: 權限管理介面的可用性測試滿意度達到 85% 以上
