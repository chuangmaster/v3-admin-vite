server {
  listen 80;
  server_name localhost;
  root /usr/share/nginx/html;

  # 訪問日誌和錯誤日誌
  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log debug;

  location / {
    try_files $uri $uri/ /index.html;
  }

  # API 反向代理：將 /api/* 轉發到後端的 /api/*
  # 使用環境變數 BACKEND_URL 來動態設置後端地址
  location /api/ {
    # 記錄反向代理請求
    access_log /var/log/nginx/api_proxy.log;

    resolver [fd12::10] valid=300s;
    # 這樣能避免運行時 DNS 問題
    # proxy_pass http://v3adminbackend.railway.internal:8080;
    proxy_pass $backend_url;

    # 設置代理標頭
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 支援 HTTPS 後端
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;

    # 支援 WebSocket
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # 超時設置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
  }
}
